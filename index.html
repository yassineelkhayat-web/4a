<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Agenda Scolaire Perso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .time-slot { transition: all 0.2s ease; cursor: pointer; position: relative; border: 1px solid #e2e8f0; }
        .time-slot:not(.pause):hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-color: #667eea; }
        .bg-gradient-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal { display: none; position: fixed; z-index: 50; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; }
        .active-modal { display: flex; }
        .pause { background-color: #f1f5f9 !important; cursor: not-allowed; border-style: dashed !important; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-weight: bold; font-style: italic; font-size: 0.8rem; }
        .course-header { font-size: 0.7rem; font-weight: 800; color: #4a5568; text-transform: uppercase; margin-bottom: 4px; display: block; background: #f8fafc; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body class="h-full w-full overflow-auto bg-gray-50 text-black">

    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gradient-custom">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Mon Agenda ðŸ“š</h1>
            <input type="text" id="username" placeholder="Ton prÃ©nom..." class="w-full p-4 border-2 border-gray-100 rounded-xl mb-4 focus:border-purple-500 outline-none text-black">
            <button onclick="login()" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition">Entrer</button>
        </div>
    </div>

    <div id="main-content" class="hidden min-h-full p-4 md:p-8 bg-gradient-custom">
        <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden text-black">
            <div class="p-8 text-center text-white bg-gradient-custom relative">
                <h1 class="text-4xl font-bold mb-2 text-white">Emploi du Temps</h1>
                <p id="welcome-user" class="text-lg opacity-90"></p>
            </div>

            <div class="p-4 md:p-8 overflow-x-auto">
                <div class="grid grid-cols-6 gap-3 min-w-[1000px]">
                    <div class="font-semibold text-gray-600"></div>
                    <div class="bg-indigo-50 text-indigo-700 font-bold text-center py-3 rounded-xl border border-indigo-100">Lundi</div>
                    <div class="bg-indigo-50 text-indigo-700 font-bold text-center py-3 rounded-xl border border-indigo-100">Mardi</div>
                    <div class="bg-indigo-50 text-indigo-700 font-bold text-center py-3 rounded-xl border border-indigo-100">Mercredi</div>
                    <div class="bg-indigo-50 text-indigo-700 font-bold text-center py-3 rounded-xl border border-indigo-100">Jeudi</div>
                    <div class="bg-indigo-50 text-indigo-700 font-bold text-center py-3 rounded-xl border border-indigo-100">Vendredi</div>
                    <div id="timetable-rows" class="contents"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col mx-4 text-black">
            <div class="p-6 bg-gradient-custom text-white flex justify-between items-center">
                <div>
                    <h2 id="detail-title" class="text-2xl font-bold text-white">DÃ©tails</h2>
                    <p id="detail-course" class="text-sm opacity-80 uppercase font-bold text-white"></p>
                </div>
                <button onclick="closeModal('detail-modal')" class="text-white text-3xl">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row h-full overflow-hidden">
                <div class="w-full md:w-1/2 p-6 overflow-y-auto border-r border-gray-100">
                    <h3 class="font-bold mb-4 text-black">ðŸ“‹ Travaux & Ã‰valuations</h3>
                    <div id="detail-items-list" class="space-y-4 mb-6"></div>
                    <div class="bg-gray-50 p-4 rounded-2xl border-2 border-dashed border-gray-200">
                        <select id="work-type" class="w-full p-2 mb-2 rounded border bg-white">
                            <option value="Devoir">ðŸ“š Devoir</option>
                            <option value="Evaluation">ðŸ”¥ Ã‰valuation</option>
                        </select>
                        <textarea id="task" placeholder="Description du travail..." class="w-full p-2 mb-2 rounded border bg-white"></textarea>
                        <button onclick="addHomework()" class="w-full py-2 bg-purple-600 text-white font-bold rounded">Enregistrer</button>
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-6 bg-gray-50 flex flex-col overflow-hidden">
                    <h3 class="font-bold mb-4 text-black">ðŸ’¬ Discussion</h3>
                    <div id="comments-container" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2 text-sm text-gray-500 italic">Clique sur un devoir pour discuter...</div>
                    <div id="comment-input-area" class="hidden flex gap-2">
                        <input type="text" id="comment-text" placeholder="Ton message..." class="flex-1 p-2 rounded border bg-white text-black">
                        <button onclick="sendComment()" class="px-4 bg-indigo-600 text-white rounded font-bold">âž¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ocoybixjephoicpwggpo.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_UbX9TrzivRZ6_HPYIb1SLQ_TveqS6aS';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const schedule = {
            "8.15-9H05": ["Anglais", "GÃ©ographie", "Physique", "MathÃ©matiques", "NÃ©erlandais"],
            "9H20-10.10": ["Anglais", "Histoire", "Physique", "MathÃ©matiques", "NÃ©erlandais"],
            "10H10-11H00": ["Biologie", "Religion", "MathÃ©matiques", "FranÃ§ais", "FranÃ§ais"],
            "11H00-11H20": ["PAUSE", "PAUSE", "PAUSE", "PAUSE", "PAUSE"],
            "11H20-12H10": ["Chimie", "Religion", "FranÃ§ais", "FranÃ§ais", "Gymnastique"],
            "12H10-13H00": ["Chimie", "NÃ©erlandais", "FranÃ§ais", "Histoire", "Gymnastique"],
            "13H00-14H15": ["PAUSE", "PAUSE", "PAUSE", "PAUSE", "PAUSE"],
            "14H15-15H05": ["MathÃ©matiques", "Anglais", "Cours Vide", "NÃ©erlandais", "Cours Vide"],
            "15H20-16H10": ["MathÃ©matiques", "Anglais", "Cours Vide", "GÃ©ographie", "Cours Vide"],
            "16H10-17H00": ["Cours Vide", "Anglais", "Cours Vide", "Cours Vide", "Cours Vide"]
        };

        let currentUser = "";
        let selectedDay = "";
        let selectedHour = "";
        let activeDevoirId = null;

        function login() {
            const name = document.getElementById('username').value;
            if (name.trim()) {
                currentUser = name;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('welcome-user').innerText = "Agenda de " + currentUser;
                initApp();
            }
        }

        function initApp() {
            generateGrid();
            fetchDevoirs();
        }

        function generateGrid() {
            const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi"];
            const container = document.getElementById('timetable-rows');
            container.innerHTML = "";

            Object.keys(schedule).forEach(time => {
                container.innerHTML += `<div class="bg-gray-100 text-gray-500 font-bold text-[10px] text-center py-4 rounded-xl border flex items-center justify-center">${time.replace('-', ' Ã  ')}</div>`;
                days.forEach((day, index) => {
                    const course = schedule[time][index];
                    const isPause = course === "PAUSE";
                    const isEmpty = course === "Cours Vide";
                    
                    container.innerHTML += `
                        <div id="cell-${day}-${time}" 
                             onclick="${!isPause ? `openDetail('${day}', '${time}', '${course}')` : ''}" 
                             class="time-slot rounded-xl p-2 min-h-[110px] bg-white ${isPause ? 'pause' : ''}">
                             ${isPause ? 'PAUSE' : `<span class="course-header">${isEmpty ? 'Libre' : course}</span>`}
                             <div class="content-area space-y-1"></div>
                        </div>`;
                });
            });
        }

        function openDetail(day, hour, course) {
            selectedDay = day;
            selectedHour = hour;
            document.getElementById('detail-title').innerText = `${day} - ${hour}`;
            document.getElementById('detail-course').innerText = (course === "Cours Vide") ? "Cours Libre" : course;
            document.getElementById('detail-modal').classList.add('active-modal');
            refreshDetailList();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active-modal');
            activeDevoirId = null;
        }

        async function addHomework() {
            const tsk = document.getElementById('task').value;
            const type = document.getElementById('work-type').value;
            const course = document.getElementById('detail-course').innerText;
            if(!tsk) return alert("Ã‰cris quelque chose !");

            const { error } = await _supabase.from('devoirs').insert([{ 
                matiere: course, description: tsk, jour: selectedDay, 
                heure: selectedHour, auteur: currentUser, type: type 
            }]);

            if(error) alert(error.message);
            document.getElementById('task').value = "";
            refreshDetailList();
            fetchDevoirs();
        }

        async function refreshDetailList() {
            const { data } = await _supabase.from('devoirs').select('*').eq('jour', selectedDay).eq('heure', selectedHour);
            const list = document.getElementById('detail-items-list');
            list.innerHTML = data.length === 0 ? "<p class='text-gray-400 italic text-center py-4 text-black'>Aucun devoir enregistrÃ©.</p>" : "";
            
            data.forEach(d => {
                const color = d.type === 'Evaluation' ? 'red' : 'purple';
                list.innerHTML += `
                    <div onclick="selectDevoir(${d.id})" class="p-3 border-l-4 border-${color}-500 bg-${color}-50 rounded-r-xl cursor-pointer hover:shadow-md transition ${activeDevoirId === d.id ? 'ring-2 ring-indigo-400' : ''}">
                        <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                            <span class="text-${color}-600">${d.type}</span>
                            <span class="text-gray-400 italic">Par ${d.auteur}</span>
                        </div>
                        <div class="text-sm font-semibold text-black">${d.description}</div>
                    </div>`;
            });
        }

        function selectDevoir(id) {
            activeDevoirId = id;
            document.getElementById('comment-input-area').classList.remove('hidden');
            refreshDetailList();
            loadComments(id);
        }

        async function loadComments(id) {
            const { data } = await _supabase.from('commentaires').select('*').eq('devoir_id', id).order('created_at');
            const container = document.getElementById('comments-container');
            container.innerHTML = data.length === 0 ? "<p class='text-center py-4 text-black'>Aucun commentaire.</p>" : "";
            data.forEach(c => {
                container.innerHTML += `<div class="bg-white p-2 rounded shadow-sm border text-black mb-1"><b class="text-indigo-600 text-[10px]">${c.auteur}:</b><br>${c.message}</div>`;
            });
            container.scrollTop = container.scrollHeight;
        }

        async function sendComment() {
            const msg = document.getElementById('comment-text').value;
            if(!msg) return;
            await _supabase.from('commentaires').insert([{ devoir_id: activeDevoirId, auteur: currentUser, message: msg }]);
            document.getElementById('comment-text').value = "";
            loadComments(activeDevoirId);
        }

        async function fetchDevoirs() {
            const { data } = await _supabase.from('devoirs').select('*');
            document.querySelectorAll('.content-area').forEach(div => div.innerHTML = "");
            data.forEach(d => {
                const cell = document.getElementById(`cell-${d.jour}-${d.heure}`);
                if (cell) {
                    const color = d.type === 'Evaluation' ? 'red' : 'purple';
                    cell.querySelector('.content-area').innerHTML += `
                        <div class="bg-${color}-100 text-${color}-800 text-[9px] px-1 rounded truncate font-bold">
                            ${d.type === 'Evaluation' ? 'ðŸ”¥' : 'ðŸ“š'} ${d.description}
                        </div>`;
                }
            });
        }
        setInterval(fetchDevoirs, 30000);
    </script>
</body>
</html>